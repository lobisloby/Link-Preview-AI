(()=>{"use strict";const e="facebook/bart-large-cnn",t="facebook/bart-large-mnli",a="cardiffnlp/twitter-roberta-base-sentiment-latest",s=["news","technology","social media","shopping","entertainment","education","business","health","travel","other"],n={enabled:!0,hoverDelay:500,showKeyPoints:!0,showCategory:!0,showSentiment:!0,showReliability:!0,theme:"auto",language:"en",excludedDomains:[],maxCacheAge:24},r={free:{previewsPerDay:25,features:["basic_preview","category"]},pro:{previewsPerDay:500,features:["basic_preview","category","sentiment","key_points","reliability","multi_language"]},team:{previewsPerDay:-1,features:["all"]}},i="YOUR_PRO_VARIANT_ID",c="YOUR_TEAM_VARIANT_ID",o="https://your-store.lemonsqueezy.com/checkout/buy/";class l{constructor(e){this.apiKey=e}async query(e,t){const a=await fetch(`https://api-inference.huggingface.co/models/${e}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify("string"==typeof t?{inputs:t}:t)});if(!a.ok){const e=await a.text();throw new Error(`API Error: ${e}`)}return a.json()}async summarize(t){try{const a=await this.query(e,{inputs:t,parameters:{max_length:150,min_length:30,do_sample:!1}});return a[0]?.summary_text||"Unable to generate summary."}catch(e){return"Summary unavailable."}}async classify(e){try{const a=await this.query(t,{inputs:e,parameters:{candidate_labels:s}}),n=a.labels[0]?.toLowerCase()||"other";return this.mapToCategory(n)}catch(e){return"other"}}async analyzeSentiment(e){try{const t=await this.query(a,e.slice(0,500)),s=t[0]?.[0];if(!s)return"neutral";const n=s.label.toLowerCase();return n.includes("positive")?"positive":n.includes("negative")?"negative":"neutral"}catch(e){return"neutral"}}mapToCategory(e){return{news:"news",technology:"tech",tech:"tech","social media":"social",social:"social",shopping:"shopping","e-commerce":"shopping",entertainment:"entertainment",education:"education",academic:"education",business:"business",finance:"business",health:"health",medical:"health",travel:"travel",tourism:"travel"}[e]||"other"}async getFullPreview(e,t){const a=t||await this.fetchPageContent(e),[s,n,r]=await Promise.all([this.summarize(a),this.classify(a),this.analyzeSentiment(a)]),i=this.extractKeyPoints(s),c=this.calculateReliability(e,a);return{url:e,title:this.extractTitle(a)||e,summary:s,keyPoints:i,category:n,sentiment:r,reliability:c,language:"en",timestamp:Date.now()}}async fetchPageContent(e){try{const t=await fetch(e),a=await t.text(),s=document.createElement("div");s.innerHTML=a;return s.querySelectorAll("script, style, nav, footer, header").forEach(e=>e.remove()),s.textContent?.slice(0,5e3)||""}catch{return e}}extractTitle(e){const t=e.split("\n").filter(e=>e.trim());return t[0]?.slice(0,100)||""}extractKeyPoints(e){return e.split(/[.!?]+/).filter(e=>e.trim().length>10).slice(0,3).map(e=>e.trim())}calculateReliability(e,t){let a=50;e.startsWith("https://")&&(a+=10);const s=["wikipedia.org","github.com","stackoverflow.com","nytimes.com","bbc.com","reuters.com","nature.com"];try{const t=new URL(e).hostname;s.some(e=>t.includes(e))&&(a+=25)}catch{}return t.length>1e3&&(a+=10),t.length>5e3&&(a+=5),Math.min(a,100)}}let u=null;const h=new class{getCheckoutUrl(e,t){const a=new URLSearchParams({checkout:"true",media:"0",embed:"1"});t&&a.append("checkout[email]",t);return`${o}${"pro"===e?i:c}?${a.toString()}`}async validateLicense(e){try{const t=await fetch("https://api.lemonsqueezy.com/v1/licenses/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:e})});if(!t.ok)return null;const a=await t.json();if(!a.valid)return null;const s=a.meta?.variant_name?.toLowerCase().includes("team")?"team":"pro";return{tier:s,expiresAt:a.license_key?.expires_at?new Date(a.license_key.expires_at).getTime():null,previewsUsed:0,previewsLimit:r[s].previewsPerDay,lemonSqueezyId:a.license_key?.id}}catch(e){return null}}async getDefaultSubscription(){const e=await chrome.storage.sync.get(["subscription","usage_date","usage_count"]),t=(new Date).toDateString(),a=e.usage_date===t?e.usage_count??0:0;return e.subscription&&"free"!==e.subscription.tier?{...e.subscription,previewsUsed:a}:{tier:"free",expiresAt:null,previewsUsed:a,previewsLimit:r.free.previewsPerDay}}async incrementUsage(){const e=await this.getDefaultSubscription();if("team"===e.tier)return!0;if(e.previewsUsed>=e.previewsLimit)return!1;const t=(new Date).toDateString(),a=await chrome.storage.sync.get(["usage_date","usage_count"]),s=(a.usage_date===t?a.usage_count??0:0)+1;return await chrome.storage.sync.set({usage_date:t,usage_count:s}),!0}async canUseFeature(e){const t=await this.getDefaultSubscription(),a=r[t.tier].features;return a.includes("all")||a.includes(e)}},m="link_preview_cache";class y{constructor(){this.cache=new Map,this.loadFromStorage()}static getInstance(){return y.instance||(y.instance=new y),y.instance}async loadFromStorage(){const e=await chrome.storage.local.get(m);if(e[m]){const t=Object.entries(e[m]);this.cache=new Map(t),this.cleanExpired()}}async saveToStorage(){const e=Object.fromEntries(this.cache);await chrome.storage.local.set({[m]:e})}cleanExpired(){const e=Date.now();for(const[t,a]of this.cache)a.expiresAt<e&&this.cache.delete(t);this.saveToStorage()}async get(e){const t=this.cache.get(e);return t?t.expiresAt<Date.now()?(this.cache.delete(e),this.saveToStorage(),null):t.data:null}async set(e,t,a=24){if(this.cache.size>=100){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}const s={data:t,timestamp:Date.now(),expiresAt:Date.now()+60*a*60*1e3};this.cache.set(e,s),await this.saveToStorage()}async clear(){this.cache.clear(),await chrome.storage.local.remove(m)}}const g=y.getInstance();async function w(e){try{const t=await g.get(e);if(t)return{success:!0,data:t};if(!await h.incrementUsage())return{success:!1,error:"Daily preview limit reached. Upgrade for more previews!"};const a=await async function(){if(!u){const e=(await chrome.storage.local.get("hf_api_key")).hf_api_key||"";u=new l(e)}return u}(),s=await a.getFullPreview(e);return await g.set(e,s),{success:!0,data:s}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function p(){const e=await chrome.storage.sync.get("settings");return e.settings?{...n,...e.settings}:n}chrome.runtime.onMessage.addListener((e,t,a)=>(async function(e){switch(e.type){case"GET_PREVIEW":return await w(e.payload);case"GET_SETTINGS":return await p();case"UPDATE_SETTINGS":return await async function(e){const t={...await p(),...e};return await chrome.storage.sync.set({settings:t}),t}(e.payload);case"CHECK_SUBSCRIPTION":return await h.getDefaultSubscription();case"INCREMENT_USAGE":return await h.incrementUsage();default:throw new Error(`Unknown message type: ${e.type}`)}}(e).then(a).catch(e=>{a({success:!1,error:e instanceof Error?e.message:"Unknown error"})}),!0)),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&(await chrome.storage.sync.set({settings:n}),chrome.tabs.create({url:chrome.runtime.getURL("options.html?welcome=true")}))});try{chrome.contextMenus&&(chrome.contextMenus.create({id:"preview-link",title:"Preview with Link Preview AI",contexts:["link"]}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{if("preview-link"===e.menuItemId&&e.linkUrl&&t?.id){const a=await w(e.linkUrl);chrome.tabs.sendMessage(t.id,{type:"SHOW_PREVIEW",payload:a})}}))}catch(e){}})();