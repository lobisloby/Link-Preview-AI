(()=>{"use strict";const e="facebook/bart-large-cnn",t="facebook/bart-large-mnli",a="cardiffnlp/twitter-roberta-base-sentiment-latest",i=["news","technology","social media","shopping","entertainment","education","business","health","travel","other"],s={enabled:!0,hoverDelay:500,showKeyPoints:!0,showCategory:!0,showSentiment:!0,showReliability:!0,theme:"auto",language:"en",excludedDomains:[],maxCacheAge:24},n={free:{previewsPerDay:25,features:["basic_preview","category"]},pro:{previewsPerDay:500,features:["basic_preview","category","sentiment","key_points","reliability","multi_language"]},team:{previewsPerDay:-1,features:["all"]}};class r{constructor(e){this.apiKey=e}async query(e,t){const a=await fetch(`https://api-inference.huggingface.co/models/${e}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify("string"==typeof t?{inputs:t}:t)});if(!a.ok){const e=await a.text();throw new Error(`API Error: ${e}`)}return a.json()}async summarize(t){try{if(t.length<50)return t;const a=await this.query(e,{inputs:t.slice(0,3e3),parameters:{max_length:150,min_length:30,do_sample:!1}});return a[0]?.summary_text||"Unable to generate summary."}catch(e){return"Summary unavailable."}}async classify(e){try{const a=await this.query(t,{inputs:e.slice(0,1e3),parameters:{candidate_labels:i}}),s=a.labels[0]?.toLowerCase()||"other";return this.mapToCategory(s)}catch(e){return"other"}}async analyzeSentiment(e){try{const t=await this.query(a,e.slice(0,500)),i=t[0]?.[0];if(!i)return"neutral";const s=i.label.toLowerCase();return s.includes("positive")?"positive":s.includes("negative")?"negative":"neutral"}catch(e){return"neutral"}}mapToCategory(e){return{news:"news",technology:"tech",tech:"tech","social media":"social",social:"social",shopping:"shopping","e-commerce":"shopping",entertainment:"entertainment",education:"education",academic:"education",business:"business",finance:"business",health:"health",medical:"health",travel:"travel",tourism:"travel"}[e]||"other"}async getFullPreview(e,t){const a=await this.fetchPageContent(e),i=t||a.text,[s,n,r]=await Promise.all([this.summarize(i),this.classify(i),this.analyzeSentiment(i)]),c=this.extractKeyPoints(s),o=this.calculateReliability(e,i),l=i.split(/\s+/).filter(e=>e.length>0).length,u=Math.max(1,Math.ceil(l/200)),h="Summary unavailable."===s&&a.description?a.description:s;return{url:e,title:a.title||this.extractTitle(i)||new URL(e).hostname,summary:h,keyPoints:c,category:n,sentiment:r,reliability:o,language:"en",timestamp:Date.now(),description:a.description,image:a.image,readingTime:u,siteName:a.siteName}}async fetchPageContent(e){const t={text:e,title:"",description:"",image:"",siteName:""};try{const a=await fetch(e,{headers:{Accept:"text/html"}});if(!a.ok)return t;const i=await a.text(),s=this.extractMeta(i,"og:title")||this.extractTagContent(i,"title")||"",n=this.extractMeta(i,"og:description")||this.extractMeta(i,"description")||this.extractMeta(i,"twitter:description")||"";let r=this.extractMeta(i,"og:image")||this.extractMeta(i,"twitter:image")||this.extractMeta(i,"twitter:image:src")||"";const c=this.extractMeta(i,"og:site_name")||this.extractMeta(i,"application-name")||"";if(r&&!r.startsWith("http"))try{r=new URL(r,e).href}catch{r=""}return{text:i.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"").replace(/<nav[\s\S]*?<\/nav>/gi,"").replace(/<footer[\s\S]*?<\/footer>/gi,"").replace(/<header[\s\S]*?<\/header>/gi,"").replace(/<aside[\s\S]*?<\/aside>/gi,"").replace(/<noscript[\s\S]*?<\/noscript>/gi,"").replace(/<svg[\s\S]*?<\/svg>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim().slice(0,5e3),title:s,description:n,image:r,siteName:c}}catch(e){return t}}extractMeta(e,t){const a=[new RegExp(`<meta[^>]*property=["']${this.escapeRegex(t)}["'][^>]*content=["']([^"']*)["']`,"i"),new RegExp(`<meta[^>]*name=["']${this.escapeRegex(t)}["'][^>]*content=["']([^"']*)["']`,"i"),new RegExp(`<meta[^>]*content=["']([^"']*)["'][^>]*property=["']${this.escapeRegex(t)}["']`,"i"),new RegExp(`<meta[^>]*content=["']([^"']*)["'][^>]*name=["']${this.escapeRegex(t)}["']`,"i")];for(const t of a){const a=e.match(t);if(a?.[1])return a[1].trim()}return""}extractTagContent(e,t){const a=new RegExp(`<${t}[^>]*>([^<]*)</${t}>`,"i"),i=e.match(a);return i?i[1].replace(/\s+/g," ").trim():""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}extractTitle(e){const t=e.split("\n").filter(e=>e.trim().length>5);return t[0]?.slice(0,120)?.trim()||""}extractKeyPoints(e){return e.split(/[.!?]+/).map(e=>e.trim()).filter(e=>e.length>15).slice(0,3)}calculateReliability(e,t){let a=50;e.startsWith("https://")&&(a+=10);const i=["wikipedia.org","github.com","stackoverflow.com","nytimes.com","bbc.com","reuters.com","nature.com","mozilla.org","developer.mozilla.org","medium.com","theguardian.com","washingtonpost.com","apnews.com"];try{const t=new URL(e).hostname;i.some(e=>t.includes(e))&&(a+=25),(t.endsWith(".edu")||t.endsWith(".gov"))&&(a+=15)}catch{}return t.length>1e3&&(a+=10),t.length>3e3&&(a+=5),Math.min(a,100)}}let c=null;const o=new class{async activateLicense(e){try{const t=await fetch("https://api.lemonsqueezy.com/v1/licenses/activate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e,instance_name:"Link Preview AI Extension"})}),a=await t.json();if(a.activated){const t=this.buildSubscription(a,e);return await chrome.storage.sync.set({subscription:t}),{success:!0,subscription:t}}const i=await this.validateLicense(e);return i?(await chrome.storage.sync.set({subscription:i}),{success:!0,subscription:i}):{success:!1,error:a.error||"Invalid license key. Please check and try again."}}catch(e){return{success:!1,error:"Network error â€” please check your connection and try again."}}}async deactivateLicense(){try{const e=(await chrome.storage.sync.get("subscription")).subscription;if(e?.licenseKey&&e?.instanceId)try{await fetch("https://api.lemonsqueezy.com/v1/licenses/deactivate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e.licenseKey,instance_id:e.instanceId})})}catch{}return await this.clearSubscription(),{success:!0}}catch(e){return await this.clearSubscription(),{success:!0}}}async validateLicense(e){try{const t=await fetch("https://api.lemonsqueezy.com/v1/licenses/validate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e})});if(!t.ok)return null;const a=await t.json();return a.valid?this.buildSubscription(a,e):null}catch(e){return null}}async getDefaultSubscription(){const e=await chrome.storage.sync.get(["subscription","usage_date","usage_count"]),t=(new Date).toDateString(),a=e.usage_date===t?e.usage_count??0:0;return e.subscription&&"free"!==e.subscription.tier?e.subscription.expiresAt&&e.subscription.expiresAt<Date.now()?(await this.clearSubscription(),this.freeSubscription(a)):{...e.subscription,previewsUsed:a}:this.freeSubscription(a)}async incrementUsage(){const e=await this.getDefaultSubscription();if("team"===e.tier)return!0;if(e.previewsUsed>=e.previewsLimit)return!1;const t=(new Date).toDateString(),a=await chrome.storage.sync.get(["usage_date","usage_count"]),i=a.usage_date===t?a.usage_count??0:0;return await chrome.storage.sync.set({usage_date:t,usage_count:i+1}),!0}async canUseFeature(e){const t=await this.getDefaultSubscription(),a=n[t.tier].features;return a.includes("all")||a.includes(e)}determineTier(e){const t=String(e?.variant_name??"").toLowerCase(),a=String(e?.product_name??"").toLowerCase();return t.includes("team")||a.includes("team")?"team":"pro"}buildSubscription(e,t){const a=this.determineTier(e.meta);return{tier:a,expiresAt:e.license_key?.expires_at?new Date(e.license_key.expires_at).getTime():null,previewsUsed:0,previewsLimit:n[a].previewsPerDay,lemonSqueezyId:e.license_key?.id?.toString(),licenseKey:t,instanceId:e.instance?.id}}async clearSubscription(){await chrome.storage.sync.set({subscription:this.freeSubscription(0)})}freeSubscription(e){return{tier:"free",expiresAt:null,previewsUsed:e,previewsLimit:n.free.previewsPerDay}}},l="link_preview_cache";class u{constructor(){this.cache=new Map,this.loadFromStorage()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async loadFromStorage(){const e=await chrome.storage.local.get(l);if(e[l]){const t=Object.entries(e[l]);this.cache=new Map(t),this.cleanExpired()}}async saveToStorage(){const e=Object.fromEntries(this.cache);await chrome.storage.local.set({[l]:e})}cleanExpired(){const e=Date.now();for(const[t,a]of this.cache)a.expiresAt<e&&this.cache.delete(t);this.saveToStorage()}async get(e){const t=this.cache.get(e);return t?t.expiresAt<Date.now()?(this.cache.delete(e),this.saveToStorage(),null):t.data:null}async set(e,t,a=24){if(this.cache.size>=100){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}const i={data:t,timestamp:Date.now(),expiresAt:Date.now()+60*a*60*1e3};this.cache.set(e,i),await this.saveToStorage()}async clear(){this.cache.clear(),await chrome.storage.local.remove(l)}}const h=u.getInstance();async function p(e){try{const t=await h.get(e);if(t)return{success:!0,data:t};if(!await o.incrementUsage())return{success:!1,error:"Daily preview limit reached. Upgrade for more previews!"};const a=await async function(){if(!c){const e=(await chrome.storage.local.get("hf_api_key")).hf_api_key||"";c=new r(e)}return c}(),i=await a.getFullPreview(e);return await h.set(e,i),{success:!0,data:i}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(){const e=await chrome.storage.sync.get("settings");return e.settings?{...s,...e.settings}:s}chrome.runtime.onMessage.addListener((e,t,a)=>(async function(e){switch(e.type){case"GET_PREVIEW":return await p(e.payload);case"GET_SETTINGS":return await m();case"UPDATE_SETTINGS":return await async function(e){const t={...await m(),...e};return await chrome.storage.sync.set({settings:t}),t}(e.payload);case"CHECK_SUBSCRIPTION":return await o.getDefaultSubscription();case"INCREMENT_USAGE":return await o.incrementUsage();case"ACTIVATE_LICENSE":return await o.activateLicense(e.payload);case"DEACTIVATE_LICENSE":return await o.deactivateLicense();default:throw new Error(`Unknown message type: ${e.type}`)}}(e).then(a).catch(e=>{a({success:!1,error:e instanceof Error?e.message:"Unknown error"})}),!0)),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&(await chrome.storage.sync.set({settings:s}),chrome.tabs.create({url:chrome.runtime.getURL("options.html?welcome=true")}))});try{chrome.contextMenus&&(chrome.contextMenus.create({id:"preview-link",title:"Preview with Link Preview AI",contexts:["link"]}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{if("preview-link"===e.menuItemId&&e.linkUrl&&t?.id){const a=await p(e.linkUrl);chrome.tabs.sendMessage(t.id,{type:"SHOW_PREVIEW",payload:a})}}))}catch(e){}})();