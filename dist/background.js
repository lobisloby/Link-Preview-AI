(()=>{"use strict";const e="facebook/bart-large-cnn",t="facebook/bart-large-mnli",a="cardiffnlp/twitter-roberta-base-sentiment-latest",s=["news","technology","social media","shopping","entertainment","education","business","health","travel","other"],i={enabled:!0,hoverDelay:500,showKeyPoints:!0,showCategory:!0,showSentiment:!0,showReliability:!0,theme:"auto",language:"en",excludedDomains:[],maxCacheAge:24},n={free:{previewsPerDay:25,features:["basic_preview","category"]},pro:{previewsPerDay:500,features:["basic_preview","category","sentiment","key_points","reliability","multi_language"]},team:{previewsPerDay:-1,features:["all"]}};class r{constructor(e){this.apiKey=e}async query(e,t){const a=await fetch(`https://api-inference.huggingface.co/models/${e}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify("string"==typeof t?{inputs:t}:t)});if(!a.ok){const e=await a.text();throw new Error(`API Error: ${e}`)}return a.json()}async summarize(t){try{const a=await this.query(e,{inputs:t,parameters:{max_length:150,min_length:30,do_sample:!1}});return a[0]?.summary_text||"Unable to generate summary."}catch(e){return"Summary unavailable."}}async classify(e){try{const a=await this.query(t,{inputs:e,parameters:{candidate_labels:s}}),i=a.labels[0]?.toLowerCase()||"other";return this.mapToCategory(i)}catch(e){return"other"}}async analyzeSentiment(e){try{const t=await this.query(a,e.slice(0,500)),s=t[0]?.[0];if(!s)return"neutral";const i=s.label.toLowerCase();return i.includes("positive")?"positive":i.includes("negative")?"negative":"neutral"}catch(e){return"neutral"}}mapToCategory(e){return{news:"news",technology:"tech",tech:"tech","social media":"social",social:"social",shopping:"shopping","e-commerce":"shopping",entertainment:"entertainment",education:"education",academic:"education",business:"business",finance:"business",health:"health",medical:"health",travel:"travel",tourism:"travel"}[e]||"other"}async getFullPreview(e,t){const a=t||await this.fetchPageContent(e),[s,i,n]=await Promise.all([this.summarize(a),this.classify(a),this.analyzeSentiment(a)]),r=this.extractKeyPoints(s),c=this.calculateReliability(e,a);return{url:e,title:this.extractTitle(a)||e,summary:s,keyPoints:r,category:i,sentiment:n,reliability:c,language:"en",timestamp:Date.now()}}async fetchPageContent(e){try{const t=await fetch(e),a=await t.text(),s=document.createElement("div");s.innerHTML=a;return s.querySelectorAll("script, style, nav, footer, header").forEach(e=>e.remove()),s.textContent?.slice(0,5e3)||""}catch{return e}}extractTitle(e){const t=e.split("\n").filter(e=>e.trim());return t[0]?.slice(0,100)||""}extractKeyPoints(e){return e.split(/[.!?]+/).filter(e=>e.trim().length>10).slice(0,3).map(e=>e.trim())}calculateReliability(e,t){let a=50;e.startsWith("https://")&&(a+=10);const s=["wikipedia.org","github.com","stackoverflow.com","nytimes.com","bbc.com","reuters.com","nature.com"];try{const t=new URL(e).hostname;s.some(e=>t.includes(e))&&(a+=25)}catch{}return t.length>1e3&&(a+=10),t.length>5e3&&(a+=5),Math.min(a,100)}}let c=null;const o=new class{async activateLicense(e){try{const t=await fetch("https://api.lemonsqueezy.com/v1/licenses/activate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e,instance_name:"Link Preview AI Extension"})}),a=await t.json();if(a.activated){const t=this.buildSubscription(a,e);return await chrome.storage.sync.set({subscription:t}),{success:!0,subscription:t}}const s=await this.validateLicense(e);return s?(await chrome.storage.sync.set({subscription:s}),{success:!0,subscription:s}):{success:!1,error:a.error||"Invalid license key. Please check and try again."}}catch(e){return{success:!1,error:"Network error â€” please check your connection and try again."}}}async deactivateLicense(){try{const e=(await chrome.storage.sync.get("subscription")).subscription;if(e?.licenseKey&&e?.instanceId)try{await fetch("https://api.lemonsqueezy.com/v1/licenses/deactivate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e.licenseKey,instance_id:e.instanceId})})}catch{}return await this.clearSubscription(),{success:!0}}catch(e){return await this.clearSubscription(),{success:!0}}}async validateLicense(e){try{const t=await fetch("https://api.lemonsqueezy.com/v1/licenses/validate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({license_key:e})});if(!t.ok)return null;const a=await t.json();return a.valid?this.buildSubscription(a,e):null}catch(e){return null}}async getDefaultSubscription(){const e=await chrome.storage.sync.get(["subscription","usage_date","usage_count"]),t=(new Date).toDateString(),a=e.usage_date===t?e.usage_count??0:0;return e.subscription&&"free"!==e.subscription.tier?e.subscription.expiresAt&&e.subscription.expiresAt<Date.now()?(await this.clearSubscription(),this.freeSubscription(a)):{...e.subscription,previewsUsed:a}:this.freeSubscription(a)}async incrementUsage(){const e=await this.getDefaultSubscription();if("team"===e.tier)return!0;if(e.previewsUsed>=e.previewsLimit)return!1;const t=(new Date).toDateString(),a=await chrome.storage.sync.get(["usage_date","usage_count"]),s=a.usage_date===t?a.usage_count??0:0;return await chrome.storage.sync.set({usage_date:t,usage_count:s+1}),!0}async canUseFeature(e){const t=await this.getDefaultSubscription(),a=n[t.tier].features;return a.includes("all")||a.includes(e)}determineTier(e){const t=String(e?.variant_name??"").toLowerCase(),a=String(e?.product_name??"").toLowerCase();return t.includes("team")||a.includes("team")?"team":"pro"}buildSubscription(e,t){const a=this.determineTier(e.meta);return{tier:a,expiresAt:e.license_key?.expires_at?new Date(e.license_key.expires_at).getTime():null,previewsUsed:0,previewsLimit:n[a].previewsPerDay,lemonSqueezyId:e.license_key?.id?.toString(),licenseKey:t,instanceId:e.instance?.id}}async clearSubscription(){await chrome.storage.sync.set({subscription:this.freeSubscription(0)})}freeSubscription(e){return{tier:"free",expiresAt:null,previewsUsed:e,previewsLimit:n.free.previewsPerDay}}},l="link_preview_cache";class u{constructor(){this.cache=new Map,this.loadFromStorage()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async loadFromStorage(){const e=await chrome.storage.local.get(l);if(e[l]){const t=Object.entries(e[l]);this.cache=new Map(t),this.cleanExpired()}}async saveToStorage(){const e=Object.fromEntries(this.cache);await chrome.storage.local.set({[l]:e})}cleanExpired(){const e=Date.now();for(const[t,a]of this.cache)a.expiresAt<e&&this.cache.delete(t);this.saveToStorage()}async get(e){const t=this.cache.get(e);return t?t.expiresAt<Date.now()?(this.cache.delete(e),this.saveToStorage(),null):t.data:null}async set(e,t,a=24){if(this.cache.size>=100){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}const s={data:t,timestamp:Date.now(),expiresAt:Date.now()+60*a*60*1e3};this.cache.set(e,s),await this.saveToStorage()}async clear(){this.cache.clear(),await chrome.storage.local.remove(l)}}const h=u.getInstance();async function p(e){try{const t=await h.get(e);if(t)return{success:!0,data:t};if(!await o.incrementUsage())return{success:!1,error:"Daily preview limit reached. Upgrade for more previews!"};const a=await async function(){if(!c){const e=(await chrome.storage.local.get("hf_api_key")).hf_api_key||"";c=new r(e)}return c}(),s=await a.getFullPreview(e);return await h.set(e,s),{success:!0,data:s}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(){const e=await chrome.storage.sync.get("settings");return e.settings?{...i,...e.settings}:i}chrome.runtime.onMessage.addListener((e,t,a)=>(async function(e){switch(e.type){case"GET_PREVIEW":return await p(e.payload);case"GET_SETTINGS":return await m();case"UPDATE_SETTINGS":return await async function(e){const t={...await m(),...e};return await chrome.storage.sync.set({settings:t}),t}(e.payload);case"CHECK_SUBSCRIPTION":return await o.getDefaultSubscription();case"INCREMENT_USAGE":return await o.incrementUsage();case"ACTIVATE_LICENSE":return await o.activateLicense(e.payload);case"DEACTIVATE_LICENSE":return await o.deactivateLicense();default:throw new Error(`Unknown message type: ${e.type}`)}}(e).then(a).catch(e=>{a({success:!1,error:e instanceof Error?e.message:"Unknown error"})}),!0)),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&(await chrome.storage.sync.set({settings:i}),chrome.tabs.create({url:chrome.runtime.getURL("options.html?welcome=true")}))});try{chrome.contextMenus&&(chrome.contextMenus.create({id:"preview-link",title:"Preview with Link Preview AI",contexts:["link"]}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{if("preview-link"===e.menuItemId&&e.linkUrl&&t?.id){const a=await p(e.linkUrl);chrome.tabs.sendMessage(t.id,{type:"SHOW_PREVIEW",payload:a})}}))}catch(e){}})();